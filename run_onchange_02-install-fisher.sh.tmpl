#!/usr/bin/env bash
# Chezmoi run_onchange script: Install Fisher and Fish plugins
# fish_plugins hash: {{ include "dot_config/fish/fish_plugins.tmpl" | sha256sum }}
set -euo pipefail

# shellcheck source=/dev/null
source "${CHEZMOI_SOURCE_DIR:-$(chezmoi source-path)}/scripts/lib/common.sh"

ensure_brew_in_path

# Check if fish is available
require_cmd fish

log "Installing Fisher and plugins..."

# Create a temporary fish script to avoid any stdin/stdout contamination
FISH_SCRIPT=$(mktemp)
cat > "$FISH_SCRIPT" << 'FISH_EOF'
# Install Fisher if not present
if not functions -q fisher
    echo "Installing Fisher..."
    curl -sL https://raw.githubusercontent.com/jorgebucaran/fisher/main/functions/fisher.fish | source
    fisher install jorgebucaran/fisher
end

# Install plugins from fish_plugins
if test -f ~/.config/fish/fish_plugins
    echo "Installing Fish plugins from fish_plugins..."
    echo "--- fish_plugins contents ---"
    cat ~/.config/fish/fish_plugins
    echo "--- end fish_plugins ---"
    fisher update
else
    echo "Warning: fish_plugins not found"
end
FISH_EOF

# Run fish with no config, isolated stdin, in a clean environment
fish --no-config "$FISH_SCRIPT" </dev/null

# Cleanup
rm -f "$FISH_SCRIPT"

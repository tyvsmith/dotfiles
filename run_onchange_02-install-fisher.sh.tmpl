#!/usr/bin/env bash
# Chezmoi run_onchange script: Install Fisher and Fish plugins
# fish_plugins hash: {{ include "dot_config/fish/fish_plugins.tmpl" | sha256sum }}
set -euo pipefail

# shellcheck source=/dev/null
source "${CHEZMOI_SOURCE_DIR:-$(chezmoi source-path)}/scripts/lib/common.sh"

ensure_brew_in_path

# Check if fish is available
require_cmd fish

# Verify fish_plugins exists
if [[ ! -f ~/.config/fish/fish_plugins ]]; then
    fail "fish_plugins not found at ~/.config/fish/fish_plugins"
fi

log "Installing Fisher and plugins..."

# Step 1: Bootstrap Fisher (with --no-config to avoid any config issues)
# This installs just the Fisher function itself
BOOTSTRAP_SCRIPT=$(mktemp)
cat > "$BOOTSTRAP_SCRIPT" << 'FISH_EOF'
# Clean up any stale Fisher-managed files first
echo "Cleaning up Fisher-managed files..."
for dir in ~/.config/fish/functions ~/.config/fish/completions ~/.config/fish/themes
    if test -d $dir
        rm -rf $dir
    end
end
# Remove plugin conf.d files (but keep our 0_*.fish files from chezmoi)
for f in ~/.config/fish/conf.d/*.fish
    if not string match -q '*/0_*' $f
        rm -f $f
    end
end

# Install Fisher only (not plugins yet)
# Temporarily hide fish_plugins so Fisher only installs itself
echo "Installing Fisher..."
mv ~/.config/fish/fish_plugins ~/.config/fish/fish_plugins.bak
curl -sL https://raw.githubusercontent.com/jorgebucaran/fisher/main/functions/fisher.fish | source
fisher install jorgebucaran/fisher
mv ~/.config/fish/fish_plugins.bak ~/.config/fish/fish_plugins
FISH_EOF

fish --no-config "$BOOTSTRAP_SCRIPT" </dev/null
rm -f "$BOOTSTRAP_SCRIPT"

# Step 2: Install plugins (with normal config so Fisher loads properly)
# This runs after Fisher is installed, simulating "exec fish" restart
log "Installing plugins..."
fish -c 'fisher update' </dev/null

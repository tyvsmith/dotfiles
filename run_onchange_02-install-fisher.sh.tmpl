#!/usr/bin/env bash
# Chezmoi run_onchange script: Install Fisher and Fish plugins
# fish_plugins hash: {{ include "dot_config/fish/fish_plugins.tmpl" | sha256sum }}
set -euo pipefail

# shellcheck source=/dev/null
source "${CHEZMOI_SOURCE_DIR:-$(chezmoi source-path)}/scripts/lib/common.sh"

ensure_brew_in_path

# Check if fish is available
require_cmd fish

log "Installing Fisher and plugins..."

# Create a temporary fish script to avoid any stdin/stdout contamination
FISH_SCRIPT=$(mktemp)
cat > "$FISH_SCRIPT" << 'FISH_EOF'
set fish_plugins_file ~/.config/fish/fish_plugins

# Debug: show what we're working with
echo "Fish config dir: ~/.config/fish"
echo "Looking for fish_plugins at: $fish_plugins_file"
if test -f $fish_plugins_file
    echo "fish_plugins exists"
else
    echo "fish_plugins NOT found"
    # Check if chezmoi deployed it elsewhere
    if test -f ~/.config/fish/fish_plugins.tmpl
        echo "Found .tmpl file instead - chezmoi may not have rendered it"
    end
    exit 1
end

# Install or update Fisher
if not functions -q fisher
    echo "Installing Fisher..."
    curl -sL https://raw.githubusercontent.com/jorgebucaran/fisher/main/functions/fisher.fish | source
    # Use update instead of install - it handles fresh installs too
    fisher update
else
    echo "Fisher already installed, updating plugins..."
    fisher update
end
FISH_EOF

# Run fish with no config, isolated stdin
fish --no-config "$FISH_SCRIPT" </dev/null

# Cleanup
rm -f "$FISH_SCRIPT"

#!/usr/bin/env bash
# Chezmoi run_onchange script: Install Fisher and Fish plugins
# fish_plugins hash: {{ include "dot_config/fish/fish_plugins.tmpl" | sha256sum }}
set -euo pipefail

# shellcheck source=/dev/null
source "${CHEZMOI_SOURCE_DIR:-$(chezmoi source-path)}/scripts/lib/common.sh"

ensure_brew_in_path
require_cmd fish
require_file ~/.config/fish/fish_plugins


log "Installing Fisher and plugins..."

# Isolate stdin to prevent stdout contamination from parent process
fish -c '
    curl -sL https://raw.githubusercontent.com/jorgebucaran/fisher/main/functions/fisher.fish | source
    for i in 1 2 3
        fisher update && break
        echo "Fisher update failed, retrying ($i/3)..."
        sleep 5
    end
' </dev/null

#!/usr/bin/env bash
# Chezmoi run_onchange script: Install Fisher and Fish plugins
# fish_plugins hash: {{ include "dot_config/fish/fish_plugins.tmpl" | sha256sum }}
set -euo pipefail

# shellcheck source=/dev/null
source "${CHEZMOI_SOURCE_DIR:-$(chezmoi source-path)}/scripts/lib/common.sh"

ensure_brew_in_path

# Check if fish is available
require_cmd fish

log "Installing Fisher and plugins..."

# Use --no-config to avoid loading user config during Fisher bootstrap
# Redirect stdin from /dev/null to prevent reading from parent process
fish --no-config -c '
# Install Fisher if not present
if not functions -q fisher
    echo "Installing Fisher..."
    curl -sL https://raw.githubusercontent.com/jorgebucaran/fisher/main/functions/fisher.fish | source
    fisher install jorgebucaran/fisher 2>&1
end

# Install plugins from fish_plugins
if test -f ~/.config/fish/fish_plugins
    echo "Installing Fish plugins from fish_plugins..."
    echo "--- fish_plugins contents ---"
    cat ~/.config/fish/fish_plugins
    echo "--- end fish_plugins ---"
    fisher update 2>&1
else
    echo "Warning: fish_plugins not found"
end
' </dev/null

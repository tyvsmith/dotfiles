#!/usr/bin/env bash
# Chezmoi run_onchange script: Install Fisher and Fish plugins
# fish_plugins hash: {{ include "dot_config/fish/fish_plugins.tmpl" | sha256sum }}
set -euo pipefail

# shellcheck source=/dev/null
source "${CHEZMOI_SOURCE_DIR:-$(chezmoi source-path)}/scripts/lib/common.sh"

ensure_brew_in_path

# Check if fish is available
require_cmd fish

log "Installing Fisher and plugins..."

# Create a temporary fish script to avoid any stdin/stdout contamination
FISH_SCRIPT=$(mktemp)
cat > "$FISH_SCRIPT" << 'FISH_EOF'
set fish_plugins_file ~/.config/fish/fish_plugins

# Check fish_plugins exists
echo "Looking for fish_plugins at: $fish_plugins_file"
if not test -f $fish_plugins_file
    echo "fish_plugins NOT found"
    exit 1
end
echo "fish_plugins exists"

# Helper function to clean Fisher-managed files
function __clean_fisher_files
    echo "Cleaning up Fisher-managed files..."
    # Remove Fisher-managed directories
    for dir in ~/.config/fish/functions ~/.config/fish/completions ~/.config/fish/themes
        if test -d $dir
            rm -rf $dir
        end
    end
    # Remove plugin conf.d files (but keep our 0_*.fish files from chezmoi)
    for f in ~/.config/fish/conf.d/*.fish
        if not string match -q '*/0_*' $f
            rm -f $f
        end
    end
end

# If Fisher function is not available, we need a fresh install
if not functions -q fisher
    echo "Fisher not loaded, performing fresh install..."
    __clean_fisher_files
    curl -sL https://raw.githubusercontent.com/jorgebucaran/fisher/main/functions/fisher.fish | source
    fisher update
else
    echo "Fisher already loaded, updating plugins..."
    fisher update
end
FISH_EOF

# Run fish with no config, isolated stdin
fish --no-config "$FISH_SCRIPT" </dev/null

# Cleanup
rm -f "$FISH_SCRIPT"

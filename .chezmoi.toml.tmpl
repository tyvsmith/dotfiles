{{- /* Machine type configuration for chezmoi

     Set via environment variables or install.sh:
       DOTFILES_IS_DEV=1 chezmoi init
       DOTFILES_UI_APPS=1 chezmoi init
       DOTFILES_DECRYPT=1 chezmoi init

     Or use install.sh for interactive prompts.
*/ -}}

{{- $envIsDev := lower (env "DOTFILES_IS_DEV") -}}
{{- $envUIApps := lower (env "DOTFILES_UI_APPS") -}}
{{- $envDecrypt := lower (env "DOTFILES_DECRYPT") -}}

{{- /* Use env vars, fall back to existing config, default to false */ -}}
{{- $isDev := false -}}
{{- $installUIApps := false -}}
{{- $shouldDecrypt := false -}}

{{- if ne $envIsDev "" -}}
{{-   $isDev = or (eq $envIsDev "1") (eq $envIsDev "true") -}}
{{- else if hasKey .chezmoi.config.data "is_dev" -}}
{{-   $isDev = .chezmoi.config.data.is_dev -}}
{{- end -}}

{{- if ne $envUIApps "" -}}
{{-   $installUIApps = or (eq $envUIApps "1") (eq $envUIApps "true") -}}
{{- else if hasKey .chezmoi.config.data "install_ui_apps" -}}
{{-   $installUIApps = .chezmoi.config.data.install_ui_apps -}}
{{- end -}}

{{- if ne $envDecrypt "" -}}
{{-   $shouldDecrypt = or (eq $envDecrypt "1") (eq $envDecrypt "true") -}}
{{- else if hasKey .chezmoi.config.data "should_decrypt" -}}
{{-   $shouldDecrypt = .chezmoi.config.data.should_decrypt -}}
{{- end -}}

{{ if $shouldDecrypt -}}
encryption = "age"
{{ end }}
[data]
    is_dev = {{ $isDev }}
    install_ui_apps = {{ $installUIApps }}
    should_decrypt = {{ $shouldDecrypt }}
{{ if $shouldDecrypt }}
[age]
    identity = "~/.config/chezmoi/age-key.txt"
    recipient = "{{ include ".age-public-key" | trim }}"
{{- end }}

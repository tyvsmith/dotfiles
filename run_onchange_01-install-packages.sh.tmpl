#!/usr/bin/env bash
# Chezmoi run_onchange script: Install packages from Brewfile
# Assumes Homebrew is already installed (via install.sh)
# Brewfile hash: {{ include "Brewfile.tmpl" | sha256sum }}

set -euo pipefail

# shellcheck source=/dev/null
DOTFILES_DIR="${CHEZMOI_SOURCE_DIR:-$(chezmoi source-path)}"
source "$DOTFILES_DIR/scripts/lib/common.sh"

ensure_brew_in_path
require_cmd brew

# Render Brewfile template to a temporary location
BREWFILE_TMPL="$DOTFILES_DIR/Brewfile.tmpl"
BREWFILE="/tmp/Brewfile.$$"
require_file "$BREWFILE_TMPL"

# Render the template using chezmoi
chezmoi execute-template < "$BREWFILE_TMPL" > "$BREWFILE"

# Run brew bundle
brew bundle --file="$BREWFILE"

# Clean up
rm -f "$BREWFILE"
